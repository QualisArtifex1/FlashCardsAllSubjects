<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Flashcards ‚Äî SRS Confidence</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <style>
    :root{
      --primary:#4169e1; --primary-dark:#27408b; --bg:#f5f7fb; --panel:#ffffff; --text:#1f2a44; --muted:#64748b; --border:#e2e8f0;
      --again:#dc2626; --hard:#d97706; --good:#2563eb; --easy:#16a34a;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0; font-family:Poppins, system-ui, -apple-system, Segoe UI, Roboto, Arial; background:var(--bg); color:var(--text); display:flex; align-items:flex-start; justify-content:center; padding:16px}
    .app{width:min(900px,100%); display:grid; gap:16px}

    .panel{background:var(--panel); border:1px solid var(--border); border-radius:14px; box-shadow:0 6px 20px rgba(0,0,0,.06); padding:16px}
    h1,h2{margin:.2rem 0 1rem; font-weight:600; text-align:center}

    button{appearance:none; border:none; border-radius:10px; padding:10px 14px; font-weight:600; cursor:pointer; color:#fff; background:var(--primary); transition:transform .08s ease, background .2s ease; box-shadow:0 2px 10px rgba(65,105,225,.25)}
    button:hover{background:var(--primary-dark)}
    button:active{transform:translateY(1px)}
    .btn-outline{background:#fff; color:var(--primary); border:1px solid var(--primary); box-shadow:none}
    .btn-ghost{background:transparent; color:var(--muted); border:1px dashed var(--border)}

    .switch{display:inline-flex; gap:8px; align-items:center; padding:6px 10px; border-radius:999px; border:1px solid var(--border); background:#fff; color:var(--text); font-weight:600}
    .switch input{accent-color:var(--primary)}

    #import-text{width:100%; min-height:180px; resize:vertical; padding:10px; border:2px solid var(--primary); border-radius:10px; font-size:16px}
    #import-note{color:var(--muted); text-align:center; margin:.5rem 0 1rem}
    .import-actions{display:flex; flex-wrap:wrap; gap:8px; justify-content:center}

    #study-panel{display:none}
    .toolbar{display:flex; flex-wrap:wrap; gap:8px; justify-content:center; align-items:center; margin-bottom:10px}
    .progress-wrap{display:grid; gap:8px}
    .progress-row{display:flex; justify-content:space-between; align-items:center; font-size:14px; color:var(--muted)}
    .bar{height:10px; background:#eef2ff; border-radius:999px; overflow:hidden; border:1px solid var(--border)}
    .bar > i{display:block; height:100%; width:0%; background:linear-gradient(90deg, var(--primary), #7aa2ff)}

    .card-container{perspective:1200px; margin:10px auto}
    .card{width:min(520px, 96vw); height:300px; margin-inline:auto; border-radius:16px; position:relative; transform-style:preserve-3d; transition:transform .6s; cursor:pointer}
    .card.flipped{transform:rotateY(180deg)}
    .card-side{position:absolute; inset:0; display:flex; align-items:center; justify-content:center; text-align:center; padding:18px; border:2px solid var(--primary); border-radius:16px; background:#fff; box-shadow:0 10px 28px rgba(0,0,0,.08); backface-visibility:hidden; font-size:clamp(18px, 3.2vw, 26px); font-weight:600}
    .card-side.back{transform:rotateY(180deg); background:var(--primary); color:#fff}

    #star-container{margin:8px 0; text-align:center}
    .star{font-size:26px; color:#c9c9c9; cursor:pointer; user-select:none; transition:transform .08s ease, color .2s}
    .star.favorited{color:#ffcc00; transform:scale(1.12)}

    .nav-buttons{display:flex; justify-content:center; gap:10px; margin:10px 0}

    .conf-row{display:flex; justify-content:center; gap:8px; margin:10px 0}
    .conf-row button{color:#fff}
    #c-again{background:var(--again)}
    #c-hard{background:var(--hard)}
    #c-good{background:var(--good)}
    #c-easy{background:var(--easy)}
    .conf-row button:disabled{opacity:.6; cursor:not-allowed}

    .dark{--bg:#0b1220; --panel:#0f172a; --text:#e5e7eb; --muted:#94a3b8; --border:#1e293b}
    .kbd{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace; background:#111827; color:#f9fafb; padding:2px 6px; border-radius:6px; font-size:12px}

    @media (max-width: 520px){ .card{height:240px} }
  </style>
</head>
<body>
  <div class="app">
    <!-- Import Panel -->
    <div id="import-panel" class="panel" aria-labelledby="import-title">
      <h1 id="import-title">Import Flashcard Data</h1>
      <p id="import-note">Paste two columns (Front ‚Üî Back). Tabs preferred, commas ok. One card per line.
        <br/>Example: <span class="kbd">amo</span> ‚áÑ <span class="kbd">I love</span></p>
      <textarea id="import-text" placeholder="Front[TAB]Back\nFront2[TAB]Back2\n..."></textarea>
      <div class="import-actions">
        <button id="import-btn" aria-label="Import">Import Cards</button>
        <button class="btn-outline" id="sample-btn" type="button">Load Sample</button>
      </div>
    </div>

    <!-- Study Panel -->
    <div id="study-panel" class="panel" aria-labelledby="study-title">
      <h2 id="study-title">Study</h2>
      <div class="toolbar" role="group" aria-label="Study controls">
        <span class="switch"><input type="checkbox" id="reverse-switch"/> <label for="reverse-switch">Reverse (Back‚ÜíFront)</label></span>
        <span class="switch"><input type="checkbox" id="star-filter"/> <label for="star-filter">Only ‚òÖ</label></span>
        <button class="btn-outline" id="shuffle-btn" type="button">Shuffle Ready</button>
        <button class="btn-outline" id="restart-btn" type="button">Restart</button>
        <button class="btn-outline" id="main-menu-btn" type="button">Main Menu</button>
        <button class="btn-ghost" id="dark-btn" type="button" title="Toggle dark mode">üåô</button>
      </div>

      <div class="progress-wrap" aria-live="polite">
        <div class="progress-row">
          <div id="progress-info">0 reviews ‚Ä¢ 0 unique</div>
          <div id="hint-keys" class="hide-mobile">Flip: <span class="kbd">Space</span> ‚Ä¢ Rate: <span class="kbd">1</span>/<span class="kbd">2</span>/<span class="kbd">3</span>/<span class="kbd">4</span></div>
        </div>
        <div class="bar" aria-hidden="true"><i id="bar-fill"></i></div>
      </div>

      <div class="card-container" id="card-area">
        <div class="card" id="flashcard" tabindex="0" role="button" aria-label="Flashcard (click or press Space to flip)">
          <div class="card-side front" id="card-front">Front</div>
          <div class="card-side back" id="card-back">Back</div>
        </div>
      </div>

      <div id="star-container">
        <span id="star-icon" class="star" title="Favorite (S)">‚òÜ</span>
      </div>

      <div class="nav-buttons" id="nav-area">
        <button id="prev-btn" type="button">‚Üê Previous</button>
        <button id="next-btn" type="button">Next ‚Üí</button>
      </div>

      <div class="conf-row">
        <button id="c-again" type="button" disabled>1 Again</button>
        <button id="c-hard"  type="button" disabled>2 Hard</button>
        <button id="c-good"  type="button" disabled>3 Good</button>
        <button id="c-easy"  type="button" disabled>4 Easy</button>
      </div>

      <div id="end-options" style="display:none; text-align:center; margin-top:12px">
        <p style="color:var(--muted); margin-bottom:10px">End of round!</p>
        <button id="study-stars-btn" class="btn-outline" type="button">Study Only ‚òÖ</button>
      </div>
    </div>
  </div>

  <script>
    // ================================
    // State
    // ================================
    let allCards = [];              // [{id, front, back, favorited, ease, interval}]
    let ready = [];                 // cards ready to draw
    let scheduled = [];             // [{card, delay}] delay = cards to wait before re-show
    let history = [];               // order we showed
    let currentIndex = -1;          // pointer in history
    let reverseMode = false;        // back->front
    let useStarsOnly = false;       // filter toggle
    let awaitingRating = false;     // after flip, require rating before proceeding
    let reviewCount = 0;            // total reviews shown

    // DOM
    const importPanel = document.getElementById('import-panel');
    const studyPanel  = document.getElementById('study-panel');
    const importText  = document.getElementById('import-text');
    const importBtn   = document.getElementById('import-btn');
    const sampleBtn   = document.getElementById('sample-btn');

    const progressInfo = document.getElementById('progress-info');
    const barFill      = document.getElementById('bar-fill');

    const flashcard    = document.getElementById('flashcard');
    const frontEl      = document.getElementById('card-front');
    const backEl       = document.getElementById('card-back');

    const starIcon     = document.getElementById('star-icon');
    const prevBtn      = document.getElementById('prev-btn');
    const nextBtn      = document.getElementById('next-btn');
    const cardArea     = document.getElementById('card-area');
    const navArea      = document.getElementById('nav-area');
    const endOptions   = document.getElementById('end-options');

    const restartBtn   = document.getElementById('restart-btn');
    const mainMenuBtn  = document.getElementById('main-menu-btn');
    const studyStarsBtn= document.getElementById('study-stars-btn');
    const reverseSwitch= document.getElementById('reverse-switch');
    const starFilter   = document.getElementById('star-filter');
    const shuffleBtn   = document.getElementById('shuffle-btn');
    const darkBtn      = document.getElementById('dark-btn');

    const btnAgain = document.getElementById('c-again');
    const btnHard  = document.getElementById('c-hard');
    const btnGood  = document.getElementById('c-good');
    const btnEasy  = document.getElementById('c-easy');

    // ================================
    // Utilities
    // ================================
    function shuffle(arr){ for(let i=arr.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1)); [arr[i],arr[j]]=[arr[j],arr[i]];} return arr }
    function djb2(str){let h=5381; for(let i=0;i<str.length;i++){ h=((h<<5)+h)+str.charCodeAt(i); h|=0 } return h.toString(36) }

    function deckIdFrom(cards){ return djb2(cards.map(c=>c.front+'\u241f'+c.back).join('\u241e')) }

    function setProgress(){
      const uniqueSeen = new Set(history.map(c=>c.id)).size;
      progressInfo.textContent = `${reviewCount} reviews ‚Ä¢ ${uniqueSeen} unique of ${allCards.length}`;
      const pct = allCards.length ? Math.round((uniqueSeen/allCards.length)*100) : 0;
      barFill.style.width = pct+"%";
    }

    function updateStarUI(on){ starIcon.textContent = on ? '‚òÖ' : '‚òÜ'; starIcon.classList.toggle('favorited', !!on); }
    function current(){ return history[currentIndex]; }

    // Persist stars + SRS state per deck
    function loadDeckState(deckId){
      try{ return JSON.parse(localStorage.getItem('deck:'+deckId) || '{}') }catch{ return {} }
    }
    function saveDeckState(deckId, state){ localStorage.setItem('deck:'+deckId, JSON.stringify(state)); }

    // ================================
    // Import
    // ================================
    sampleBtn.addEventListener('click', ()=>{
      importText.value = [ 'amo\tI love', 'laudo\tI praise', 'porto\tI carry', 'puella\tgirl', 'rosa\trose' ].join('\n');
      importText.focus();
    });

    importBtn.addEventListener('click', ()=>{
      const raw = importText.value.trim();
      if(!raw){ alert('Please paste some two‚Äëcolumn data first.'); return; }
      const lines = raw.split(/\r?\n/).filter(l=>l.trim());
      const parsed = lines.map(line=>{ let parts=line.split('\t'); if(parts.length<2){parts=line.split(',')} return {front:(parts[0]||'').trim(), back:parts.slice(1).join(',').trim()} }).filter(x=>x.front && x.back);
      if(!parsed.length){ alert('No valid lines found. Each line needs at least two columns.'); return; }

      const deckId = deckIdFrom(parsed);
      const saved = loadDeckState(deckId);

      allCards = parsed.map(({front,back})=>{
        const id = djb2(front+'\u241f'+back);
        const savedCard = (saved.cards||{})[id] || {};
        return { id, front, back, favorited: !!savedCard.favorited, ease: savedCard.ease ?? 2.5, interval: savedCard.interval ?? 0 };
      });

      startStudy(deckId, saved);
    });

    // ================================
    // Study lifecycle
    // ================================
    let deckId = null; let deckSaved = null;

    function startStudy(id, saved){
      deckId = id; deckSaved = saved || {};
      useStarsOnly = false; reviewCount = 0; awaitingRating=false; history=[]; currentIndex=-1; scheduled=[];
      ready = buildInitialReady();

      importPanel.style.display='none';
      studyPanel.style.display='block';
      flashcard.classList.remove('flipped');
      enableConf(false);
      drawNext();
    }

    function buildInitialReady(){
      const base = useStarsOnly ? allCards.filter(c=>c.favorited) : allCards.slice();
      return shuffle(base);
    }

    function enableConf(on){ [btnAgain,btnHard,btnGood,btnEasy].forEach(b=>b.disabled=!on); }

    // Advance scheduled delays by one card shown
    function tickSchedule(){ for(const s of scheduled){ s.delay = Math.max(0, s.delay-1) } }

    function popReadyCard(){
      if(ready.length>0){ return ready.splice(Math.floor(Math.random()*ready.length),1)[0]; }
      // bring due scheduled into ready
      const due = scheduled.filter(s=>s.delay<=0).map(s=>s.card);
      scheduled = scheduled.filter(s=>s.delay>0);
      if(due.length){ ready.push(...due); return popReadyCard(); }
      return null;
    }

    function drawNext(){
      if(awaitingRating) return; // must rate current card

      // If we have history ahead (after Previous), step forward without changing schedule
      if(currentIndex < history.length-1){ currentIndex++; updateDisplay(); setProgress(); return; }

      // normal path
      const next = popReadyCard();
      if(!next){ endOfRound(); return; }
      tickSchedule();
      history.push(next); currentIndex = history.length-1; reviewCount++;
      updateDisplay(); setProgress();
    }

    function updateDisplay(){
      const c = current(); if(!c) return;
      flashcard.classList.remove('flipped');
      frontEl.textContent = reverseMode ? c.back : c.front;
      backEl.textContent  = reverseMode ? c.front : c.back;
      updateStarUI(c.favorited);
      endOptions.style.display='none'; cardArea.style.display='block'; navArea.style.display='flex'; starIcon.style.display='inline-block';
      enableConf(false); awaitingRating=false; // not flipped yet
    }

    function endOfRound(){ cardArea.style.display='none'; navArea.style.display='none'; starIcon.style.display='none'; endOptions.style.display='block'; }

    function saveState(){
      const obj = { cards:{} };
      for(const c of allCards){ obj.cards[c.id] = { favorited:c.favorited, ease:c.ease, interval:c.interval } }
      saveDeckState(deckId, obj);
    }

    // ================================
    // Rating logic (Anki‚Äëstyle simplified)
    // ================================
    function rate(choice){
      const c = current(); if(!c) return;
      // update ease/interval
      if(choice==='again'){ c.ease = Math.max(1.3, (c.ease||2.5) - 0.20); c.interval = 1; }
      else if(choice==='hard'){ c.ease = Math.max(1.3, (c.ease||2.5) - 0.05); c.interval = Math.max(2, Math.round((c.interval||0)*1.2) || 2); }
      else if(choice==='good'){ const e=c.ease||2.5; c.interval = Math.max(3, Math.round((c.interval||1)*e) || 5); }
      else if(choice==='easy'){ c.ease = (c.ease||2.5) + 0.05; const e=c.ease+0.15; c.interval = Math.max(5, Math.round((c.interval||1)*e) || 10); }

      // schedule back into future draws
      scheduled.push({ card:c, delay:c.interval });
      saveState();

      awaitingRating=false; enableConf(false); drawNext();
    }

    // ================================
    // Events
    // ================================
    flashcard.addEventListener('click', ()=>{ flashcard.classList.toggle('flipped'); awaitingRating = flashcard.classList.contains('flipped'); enableConf(awaitingRating); });
    flashcard.addEventListener('keydown', (e)=>{ if(e.code==='Space'){ e.preventDefault(); flashcard.click(); } });

    starIcon.addEventListener('click', ()=>{ const c=current(); if(!c) return; c.favorited=!c.favorited; updateStarUI(c.favorited); saveState(); });

    prevBtn.addEventListener('click', ()=>{ if(currentIndex>0 && !awaitingRating){ currentIndex--; updateDisplay(); setProgress(); }});
    nextBtn.addEventListener('click', ()=>{ drawNext(); });

    document.getElementById('study-stars-btn').addEventListener('click', ()=>{ useStarsOnly=true; ready=buildInitialReady(); history=[]; currentIndex=-1; scheduled=[]; reviewCount=0; drawNext(); });
    restartBtn.addEventListener('click', ()=>{ ready=buildInitialReady(); history=[]; currentIndex=-1; scheduled=[]; reviewCount=0; drawNext(); });
    mainMenuBtn.addEventListener('click', ()=>{ location.reload(); });

    reverseSwitch.addEventListener('change', e=>{ reverseMode = e.target.checked; updateDisplay(); });
    starFilter.addEventListener('change', e=>{ useStarsOnly = e.target.checked; ready=buildInitialReady(); history=[]; currentIndex=-1; scheduled=[]; reviewCount=0; drawNext(); });
    shuffleBtn.addEventListener('click', ()=>{ ready = shuffle(ready); });

    // Confidence buttons
    btnAgain.addEventListener('click', ()=>rate('again'));
    btnHard .addEventListener('click', ()=>rate('hard'));
    btnGood .addEventListener('click', ()=>rate('good'));
    btnEasy .addEventListener('click', ()=>rate('easy'));

    // Hotkeys: 1/2/3/4 for rating when flipped
    window.addEventListener('keydown', (e)=>{
      if(studyPanel.style.display!=='block') return;
      if(['INPUT','TEXTAREA'].includes(document.activeElement.tagName)) return;
      if(awaitingRating){
        if(e.key==='1') rate('again');
        else if(e.key==='2') rate('hard');
        else if(e.key==='3') rate('good');
        else if(e.key==='4') rate('easy');
      } else {
        if(e.code==='Space'){ e.preventDefault(); flashcard.click(); }
      }
    });

    // Touch swipe (mobile)
    let startX=null; flashcard.addEventListener('touchstart', e=>{ startX = e.changedTouches[0].clientX }, {passive:true});
    flashcard.addEventListener('touchend', e=>{
      if(startX===null) return; const dx = e.changedTouches[0].clientX - startX; startX=null;
      if(Math.abs(dx) < 40){ flashcard.click(); return; }
      if(dx>0){ if(currentIndex>0 && !awaitingRating){ currentIndex--; updateDisplay(); setProgress(); } }
      else{ if(!awaitingRating) drawNext(); }
    }, {passive:true});

    // Dark mode toggle
    const root = document.documentElement; darkBtn.addEventListener('click', ()=>{ root.classList.toggle('dark'); });
  </script>
</body>
</html>
